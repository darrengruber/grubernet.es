version: 2
jobs:
  build:
    branches:
      only:
        - master
    docker:
      - image: cibuilds/hugo:latest
    working_directory: /root/hugo
    environment:
      HUGO_BUILD_DIR: /tmp/public
    steps:

      - add_ssh_keys:
          fingerprints:
            - "52:e7:3a:2d:f5:80:e4:c5:9f:15:cf:12:d5:6e:b0:79"

      - run:
          name: install and configure git
          command: |
            apk update && apk add git
            git config --global user.email "dgruber@gmail.com"
            git config --global user.name "Darren Gruber"

      # checkout the repository
      - checkout

      - run:
          name: build with HUGO
          command: HUGO_ENV=production hugo -v -d $HUGO_BUILD_DIR

      - run:
          name: move all html to master branch
          command: |
            git fetch --all
            git checkout -f gh-pages
            rm -rf *
            mv /tmp/public/* .
            git add .
            git commit -m "Update HTML"

      - run:
          name: test our generated HTML files
          command: |
            htmlproofer . --allow-hash-href --check-html \
            --empty-alt-ignore --disable-external

      - run:
          name: push gh-pages branch
          command: git push -f origin HEAD
